<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam PDF Generator</title>
    <style>
        /* -----------------------------------------------------------
           UI STYLES (Screen Only)
           ----------------------------------------------------------- */
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg-ui: #f8fafc;
            --text-ui: #1e293b;
            --border-ui: #cbd5e1;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-ui);
            color: var(--text-ui);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        #ui-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        h1 {
            margin-top: 0;
            text-align: center;
            color: var(--primary);
        }

        h2 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0.5rem;
        }

        .section {
            margin-bottom: 2rem;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
        }

        .input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-ui);
            border-radius: 6px;
        }

        button {
            padding: 10px 20px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }

        button:hover {
            background-color: var(--primary-hover);
        }

        textarea {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 1px solid var(--border-ui);
            border-radius: 6px;
            font-family: monospace;
            resize: vertical;
        }

        #json-error {
            color: #dc2626;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            display: none;
        }

        .full-width-btn {
            width: 100%;
            font-size: 1.1rem;
            padding: 15px;
            margin-top: 1rem;
        }

        /* -----------------------------------------------------------
           PRINT STYLES (The PDF Generator Core)
           ----------------------------------------------------------- */
        #print-container {
            display: none;
        }

        @media print {
            @page {
                size: A4;
                margin: 0;
                /* CRITICAL: Edge-to-edge background */
            }

            body {
                margin: 0;
                padding: 0;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                /* Background color will be set via JS inline style on document.body */
            }

            #ui-container {
                display: none !important;
            }

            #print-container {
                display: block !important;
            }

            /* Safe Area Wrapper */
            .page-content-wrapper {
                /* Fixed padding as per requirements */
                padding: 25mm 20mm 25mm 20mm;
                box-sizing: border-box;
                width: 210mm;
                /* A4 width */
                min-height: 297mm;
                /* Full page height ensuring color covers even if content is short */

                /* Ensure text never flows out */
                overflow: visible;
            }

            /* Global Typography for Exam */
            .exam-text {
                font-family: 'Kalpurush', 'Nirmala UI', sans-serif;
                /* Fallback to system Bangla */
                color: #000;
            }

            /* Page 1: Cover Page */
            .cover-page {
                display: flex;
                flex-direction: column;
                align-items: center;
                text-align: center;
                height: calc(297mm - 50mm);
                /* Approximate content height */
                page-break-after: always;
                position: relative;
            }

            .set-info-top {
                display: flex;
                justify-content: space-between;
                width: 100%;
                font-weight: bold;
                font-size: 1.1rem;
                margin-bottom: 2rem;
            }

            .exam-title-block {
                margin-top: 3rem;
                margin-bottom: 3rem;
            }

            .exam-title-block h1 {
                font-size: 2.5rem;
                color: #000;
                margin-bottom: 0.5rem;
            }

            .exam-year {
                font-size: 2rem;
                font-weight: bold;
            }

            .exam-meta {
                margin: 2rem 0;
                font-size: 1.2rem;
                font-weight: bold;
            }

            .instructions {
                margin-top: auto;
                width: 100%;
                border-top: 2px solid #000;
                padding-top: 1rem;
                text-align: left;
                font-size: 0.95rem;
            }

            .instruction-note {
                margin-top: 0.5rem;
                font-size: 0.9rem;
            }

            /* Page 2+: Questions Page */
            .questions-page {
                /* Continues flow. If it needs multiple pages, browser handles it. */
            }

            .questions-header {
                display: flex;
                justify-content: space-between;
                font-weight: bold;
                margin-bottom: 1rem;
                border-bottom: 1px solid #000;
                padding-bottom: 0.5rem;
            }

            .question-columns {
                column-count: 2;
                column-gap: 10mm;
                /* 1cm gap */
                widows: 2;
                orphans: 2;
            }

            .question-item {
                break-inside: avoid;
                -webkit-column-break-inside: avoid;
                page-break-inside: avoid;
                /* Robust formatting */
                display: inline-block;
                width: 100%;
                margin-bottom: 1rem;
                text-align: justify;
                font-size: 0.95rem;
            }

            .page-footer {
                position: fixed;
                bottom: 10mm;
                left: 0;
                width: 100%;
                text-align: center;
                font-size: 0.8rem;
                border-top: 1px solid #ccc;
                padding-top: 5px;
                background: white;
                /* Cover anything behind */
            }

            .q-text {
                font-weight: bold;
                display: block;
                margin-bottom: 0.3rem;
            }

            .q-options {
                display: flex;
                gap: 0.5rem;
            }

            .q-options.horizontal {
                flex-direction: row;
                flex-wrap: wrap;
                align-items: center;
            }

            .q-options.vertical {
                flex-direction: column;
            }

            .q-opt {
                display: flex;
                gap: 0.4rem;
                align-items: baseline;
            }

            /* Final Page: Answer Key */
            .answer-key-section {
                break-before: page;
                margin-top: 2rem;
            }

            .answer-header {
                text-align: center;
                font-size: 1.5rem;
                font-weight: bold;
                margin-bottom: 1.5rem;
            }

            .answer-grid {
                column-count: 5;
                column-gap: 1rem;
                font-size: 0.9rem;
            }

            .answer-item {
                break-inside: avoid;
                margin-bottom: 0.2rem;
            }

            /* OMR Sheet Styles */
            .omr-section {
                break-before: page;
                margin-top: 0;
            }

            .omr-header {
                text-align: center;
                border-bottom: 2px solid #000;
                padding-bottom: 10px;
                margin-bottom: 20px;
            }

            .omr-grid-container {
                column-count: 4;
                /* 4 columns of bubbles to save space */
                column-gap: 15px;
                width: 100%;
            }

            .omr-row {
                break-inside: avoid;
                display: flex;
                align-items: center;
                margin-bottom: 8px;
                gap: 8px;
                font-family: sans-serif;
                /* System font for bubbles usually clearer, but we can stick to 'Kalpurush' if preferred. 
                   Let's use system sans-serif for clean circles */
            }

            .omr-q-num {
                width: 30px;
                text-align: right;
                font-weight: bold;
                font-family: 'Kalpurush', sans-serif;
            }

            .omr-bubbles {
                display: flex;
                gap: 8px;
            }

            .omr-bubble {
                width: 20px;
                height: 20px;
                border-radius: 50%;
                border: 1px solid #000;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 10px;
                color: #444;
            }
        }
    </style>
</head>

<body>

    <!-- UI SECTION -->
    <div id="ui-container">
        <h1>Exam PDF Generator</h1>

        <!-- Section 1 -->
        <div class="section">
            <h2>1. Get JSON</h2>
            <div class="input-group">
                <input type="text" id="examId" placeholder="Enter Exam ID (e.g., 101)">
                <button onclick="openApiLink()">GO</button>
            </div>
            <small style="color: #64748b;">Click GO to open data link. Copy raw JSON from there.</small>
        </div>

        <!-- Section 2 -->
        <div class="section">
            <h2>2. Paste Data</h2>
            <label for="jsonInput" style="display:block; margin-bottom:0.5rem;">Paste raw JSON here:</label>
            <textarea id="jsonInput" placeholder='{"success": true, "data": { ... }}'></textarea>
            <div id="json-error">Invalid JSON format. Please check your data.</div>
        </div>

        <!-- Section 3 -->
        <div class="section">
            <h2>3. Exam Details (Optional)</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label style="font-size: 0.9rem; font-weight: bold;">Exam Title</label>
                    <input type="text" id="customTitle" placeholder="Default: প্রিলিমিনারি টেস্ট">
                </div>
                <div>
                    <label style="font-size: 0.9rem; font-weight: bold;">Year</label>
                    <input type="text" id="customYear" placeholder="Default: 2026">
                </div>
                <div>
                    <label style="font-size: 0.9rem; font-weight: bold;">Time</label>
                    <input type="text" id="customTime" placeholder="Default from JSON">
                </div>
                <div>
                    <label style="font-size: 0.9rem; font-weight: bold;">Full Marks</label>
                    <input type="text" id="customMarks" placeholder="Default from JSON">
                </div>
            </div>
        </div>

        <!-- Section 4 -->
        <div class="section">
            <button class="full-width-btn" onclick="processAndPrint()">Generate PDF Questions</button>
        </div>
    </div>

    <!-- PRINT SECTION -->
    <div id="print-container">
        <!-- Content injected via JS -->
    </div>

    <script>
        // -----------------------------------------------------------
        // CONFIG & UTILS
        // -----------------------------------------------------------
        const BG_COLORS = [
            '#FFE4E1', // Light Pink
            '#FFFFE0', // Light Yellow
            '#F0FFF0', // Pastel Green
            '#F5F5F5'  // Ash / Light Grey
        ];

        const SETS = [
            { num: '১', name: 'পদ্মা' },
            { num: '২', name: 'মেঘনা' },
            { num: '৩', name: 'যমুনা' },
            { num: '৪', name: 'কর্ণফুলী' },
            { num: '৫', name: 'শাপলা' },
            { num: '৬', name: 'গোলাপ' },
            { num: '৭', name: 'জুঁই' },
            { num: '৮', name: 'রজনীগন্ধা' }
        ];

        const BANGLA_DIGITS = ['০', '১', '২', '৩', '৪', '৫', '৬', '৭', '৮', '৯'];
        const BANGLA_OPTIONS = { 'A': 'ক', 'B': 'খ', 'C': 'গ', 'D': 'ঘ' };

        // Helper to convert English number string to Bangla
        function toBanglaNum(numStr) {
            return numStr.toString().replace(/\d/g, d => BANGLA_DIGITS[d]);
        }

        // Helper to shuffle array
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // -----------------------------------------------------------
        // UI ACTIONS
        // -----------------------------------------------------------
        function openApiLink() {
            const id = document.getElementById('examId').value.trim();
            if (!id) return alert('Please enter an Exam ID');
            const url = `https://bcspreli.free.nf/api/take-exam/start.php?exam_id=${id}`;
            window.open(url, '_blank');
        }

        function validateJSON() {
            const raw = document.getElementById('jsonInput').value;
            const errDiv = document.getElementById('json-error');
            try {
                const parsed = JSON.parse(raw);
                if (!parsed.success || !parsed.data) throw new Error('Invalid Schema');
                errDiv.style.display = 'none';
                return parsed.data;
            } catch (e) {
                errDiv.style.display = 'block';
                errDiv.textContent = 'Invalid JSON: ' + e.message;
                return null;
            }
        }

        // -----------------------------------------------------------
        // PDF GENERATION LOGIC
        // -----------------------------------------------------------
        function processAndPrint() {
            const data = validateJSON();
            if (!data) return;

            // 1. Randomization
            const bg = BG_COLORS[Math.floor(Math.random() * BG_COLORS.length)];
            const set = SETS[Math.floor(Math.random() * SETS.length)];
            const questions = shuffleArray([...data.questions]);
            const details = data.details || {};

            // 1.1 Custom Overrides
            const customTitle = document.getElementById('customTitle').value.trim();
            const customYear = document.getElementById('customYear').value.trim();
            const customTime = document.getElementById('customTime').value.trim();
            const customMarks = document.getElementById('customMarks').value.trim();

            // Look for 'exam_title' specifically as requested, fallback to 'title'
            const jsonTitle = details.exam_title || details.title;
            const finalTitle = customTitle || jsonTitle || "প্রিলিমিনারি টেস্ট";

            const finalYear = customYear || details.year || "2026";
            const finalTime = customTime || details.time || "২ ঘণ্টা";
            const finalMarks = customMarks || details.full_marks || "200";

            // 2. Apply Print Styles
            document.body.style.backgroundColor = bg;

            // 3. Build HTML
            const container = document.getElementById('print-container');
            container.innerHTML = '';

            // --- CUSTOM FOOTER (Repeating) ---
            const footer = document.createElement('div');
            footer.className = 'page-footer';
            footer.innerHTML = `${finalTitle} | Set: ${set.name} (${set.num})`;
            container.appendChild(footer);

            /* --- PAGE 1: COVER --- */
            const coverDiv = document.createElement('div');
            coverDiv.className = 'page-content-wrapper cover-page';

            coverDiv.innerHTML = `
                <div class="set-info-top">
                    <span>সেট নম্বর <br> <span style="font-size:1.5rem">${set.num}</span></span>
                    <span style="text-align:right">কোড নাম <br> ${set.name}</span>
                </div>
                
                <div class="exam-title-block">
                    <h1>${finalTitle}</h1>
                    <div class="exam-year">${toBanglaNum(finalYear)}</div>
                </div>

                <div class="exam-meta">
                    সময়: ${finalTime}<br>
                    পূর্ণমান: ${toBanglaNum(finalMarks)}
                </div>

                <div class="instructions">
                    [মোট প্রশ্ন ${toBanglaNum(questions.length)} টি। প্রতিটি প্রশ্নের মান ১। প্রতিটি ভুল উত্তরের জন্য ০.৫ নম্বর কাটা যাবে।]
                    <div class="instruction-note">
                        উত্তরপত্রের প্রথম অংশে রেজিস্ট্রেশন নম্বর যথাযথভাবে না লিখলে, সঠিক ঘর ভরাট না করলে উত্তরপত্র বাতিল হবে।
                    </div>
                </div>
            `;
            container.appendChild(coverDiv);

            // --- PAGE 2+: QUESTIONS (Using Table for Repeating Header) ---
            const table = document.createElement('table');
            table.className = 'questions-table';
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.marginTop = '0'; // Reset

            // THEAD - Repeats on every page
            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th style="font-weight:normal; text-align:left; padding-bottom: 0.5rem;">
                        <div class="questions-header" style="display:flex; justify-content:space-between; border-bottom:1px solid #000; padding-bottom:0.5rem; margin-bottom:1rem; margin-top:1.5rem;">
                            <span>${set.name}</span>
                            <span>সেট-${set.num}</span>
                        </div>
                    </th>
                </tr>
            `;
            table.appendChild(thead);

            // TBODY - Contains Columns
            const tbody = document.createElement('tbody');
            const tr = document.createElement('tr');
            const td = document.createElement('td');

            // The column container
            td.innerHTML = `
                <div class="question-columns">
                    ${questions.map((q, idx) => {
                // Heuristic for layout: Horizontal vs Vertical
                // Column width approx 80mm ~ 300px. Safe limit ~260px.
                const MAX_W = 260;
                const ctx = document.createElement('canvas').getContext('2d');
                ctx.font = "0.95rem 'Kalpurush', 'Nirmala UI', sans-serif";

                let totalW = 0;
                let mode = 'horizontal';
                const vals = [q.options.A, q.options.B, q.options.C, q.options.D];

                for (let v of vals) {
                    const w = ctx.measureText("(ক) " + v).width;
                    if (w > MAX_W) { mode = 'vertical'; break; } // Single option too long
                    totalW += w + 20; // +gap
                }
                if (totalW > MAX_W) mode = 'vertical';

                return `
                        <div class="question-item exam-text">
                            <span class="q-text">${toBanglaNum(idx + 1)}। ${q.question}</span>
                            <div class="q-options ${mode}">
                                <div class="q-opt"><span>(ক)</span> <span>${q.options.A}</span></div>
                                <div class="q-opt"><span>(খ)</span> <span>${q.options.B}</span></div>
                                <div class="q-opt"><span>(গ)</span> <span>${q.options.C}</span></div>
                                <div class="q-opt"><span>(ঘ)</span> <span>${q.options.D}</span></div>
                            </div>
                        </div>
                        `;
            }).join('')}
                </div>
            `;

            tr.appendChild(td);
            tbody.appendChild(tr);
            table.appendChild(tbody);

            // Wrap table in page content style but without fixed padding to avoid double padding if table handles it
            // Actually, we need the padding wrapper around the table OR inside. 
            // Better: The Table IS the page content structure essentially.
            // But we need safe area margins. 
            // We can wrap the table in a div with padding 25mm 20mm... ? 
            // No, that wrapper won't fragment well.
            // Best approach: Give the TABLE styles to respect margin, 
            // OR put the table inside a div that has the print padding.
            // Let's use a wrapper for page 2 that enforces padding.
            const qPageWrapper = document.createElement('div');
            qPageWrapper.className = 'page-content-wrapper';
            qPageWrapper.style.display = 'block'; // standard flow
            qPageWrapper.appendChild(table);

            container.appendChild(qPageWrapper);

            // --- ANSWER KEY ---
            const ansWrapper = document.createElement('div');
            ansWrapper.className = 'page-content-wrapper answer-key-section';
            ansWrapper.innerHTML = `
                <div class="answer-header">উত্তরমালা</div>
                <div class="answer-grid">
                    ${questions.map((q, idx) => `
                        <div class="answer-item">
                            ${toBanglaNum(idx + 1)} -> ${BANGLA_OPTIONS[q.answer] || q.answer}
                        </div>
                    `).join('')}
                </div>
            `;
            container.appendChild(ansWrapper);

            // --- OMR SHEET ---
            const omrWrapper = document.createElement('div');
            omrWrapper.className = 'page-content-wrapper omr-section';
            omrWrapper.innerHTML = `
                <div class="omr-header">
                    <h2>OMR উত্তরপত্র</h2>
                    <div style="display:flex; justify-content:space-around; font-size:0.9rem; margin-top:5px;">
                        <span>সেট: ${set.name} (${set.num})</span>
                        <span>মোট প্রশ্ন: ${toBanglaNum(questions.length)}</span>
                    </div>
                    <p style="font-size:0.8rem; margin:5px 0 0 0;">সঠিক বৃত্তটি কালো কালির বলপয়েন্ট কলম দ্বারা ভরাট করুন।</p>
                </div>
                <div class="omr-grid-container">
                    ${questions.map((_, idx) => `
                        <div class="omr-row">
                            <span class="omr-q-num">${toBanglaNum(idx + 1)}.</span>
                            <div class="omr-bubbles">
                                <div class="omr-bubble">ক</div>
                                <div class="omr-bubble">খ</div>
                                <div class="omr-bubble">গ</div>
                                <div class="omr-bubble">ঘ</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            container.appendChild(omrWrapper);

            // 4. Trigger Print
            // Change document title to suggest filename
            const originalTitle = document.title;
            // Use exactly the finalTitle which contains the json exam_title
            document.title = finalTitle;

            // Small delay to ensure rendering
            setTimeout(() => {
                window.print();
                // Restore title after a delay (enough for dialog to open)
                setTimeout(() => { document.title = originalTitle; }, 2000);
            }, 500);
        }
    </script>
</body>

</html>
